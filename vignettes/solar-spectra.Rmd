
---
title: "The solar spectrum"
author: "Taha Ahmed"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The solar spectrum}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r packages, echo=T, message=FALSE}
library(dplyr)
library(tidyr)
library(stringr)  # str_remove
library(knitr)
library(ggplot2)
library(latex2exp)
library(cowplot)
library(here)
```

```{r global_options, echo=T, message=FALSE}
options(
   digits   = 7,
   width    = 84,
   continue = " ",
   prompt   = "> ",
   warn = 0,
   stringsAsFactors = FALSE)
opts_chunk$set(
   dev        = "svg",
   fig.align  = "center",
   fig.width  = 7.10,
   # 7.10/4.39=1.617 golden ratio
   # but we increase height slightly to make allowance for title,
   # secondary axis, caption, etc.
   fig.height = 4.58,
   echo       = TRUE,
   eval       = TRUE,
   cache      = FALSE,
   collapse   = TRUE,
   results    = 'hide',
   message    = FALSE,
   warning    = FALSE,
   tidy       = FALSE)
```


As our energy system must urgently transition to a larger dependence on
solar energy, I thought it could be worthwhile to walk through the physical
limits imposed by the terrestrial solar spectrum.

We start with the reference solar spectrum ASTM G173-03, as defined by ASTM and
published by NREL, which is included as `ASTMG173` in this package:

```{r dataset, echo=TRUE, results="markup"}
dataset <- photoec::ASTMG173
dataset %>% glimpse()
```

This dataframe is in wide format. To make plotting (with ggplot2) faster, let's
transform it to long format.

```{r transform-data, echo=TRUE, results="markup"}
# while we are at it, let's give the existing columns more descriptive names
dataset <- dataset %>%
   rename(AM0 = extraterrestrial) %>%
   rename(AM1.5G = globaltilt) %>%
   # direct normal circumsolar
   rename(DNCS = direct.circumsolar)
datalong <- dataset %>% pivot_longer(
   cols = !starts_with("wavelength"),
   names_to = "model",
   values_to = "value") %>%
   mutate(property = "spectral.irradiance")
datalong %>% glimpse()
```



```{r astmg173-dataset, echo=FALSE}
ggplot(datalong) +
   geom_line(linewidth = 0.2,
      aes(
         x = wavelength,
         y = value,
         colour = model)) +
   scale_x_continuous(
      name = "Wavelength / nm",
      breaks = c(250, 1000, 2000, 3000, 4000),
      sec.axis = sec_axis(
         ~ 1239.842 / .,
         name = "Energy / eV",
         breaks = c(4, 2, 1, 0.5))) +
   scale_y_continuous(name = "Spectral irradiance / (W/m²/nm)") +
   labs(
      title = "ASTM G173-03 reference solar spectra",
      # note that <code></code> (i.e., ``) is not supported yet by ggtext
      # and apparently \texttt{} is not supported by latex2exp::TeX()
      caption = latex2exp::TeX(r"(Data source: \textbf{photoec::ASTMG173})")) +
   theme(
      legend.position = c(0.98, 0.98),
      legend.justification = c(1, 1))
```


Now, as a sanity check, let's compare the spectra returned by this package's
`sunlight.ASTM()` function with those above (should be an exact match).

```{r astmg173-function, echo=FALSE}
dflong <- sunlight.ASTM() %>%
   pivot_longer(
      cols = !starts_with(c("wavelength", "energy")),
      names_to = "astm.colname",
      values_to = "value") %>%
   # replace everything *after* AM0/AM1.5G/DNCS (starting with the dot) with empty string
   # this way we extract the "model" out of the former column names now populating
   # the "astm.colname" column
   mutate(model = sub("\\.[a-z]+(\\.[a-z]+)?", "", astm.colname)) %>%
   mutate(property = sub("^\\.", "", str_remove(astm.colname, model))) %>%
   # this leaves spectral irradiance values with empty string in "property" column
   mutate(property = ifelse(property == "", "spectral.irradiance", property)) %>%
   # with that we have successfully parsed the original column names and no longer
   # need the astm.colname column
   select(-astm.colname)
dflong %>% glimpse()
```

```{r astm-function, echo=FALSE}
ggplot(dflong %>% filter(property == "spectral.irradiance")) +
   geom_line(linewidth = 0.2,
      aes(
         x = wavelength,
         y = value,
         colour = model)) +
   scale_x_continuous(
      name = "Wavelength / nm",
      breaks = c(250, 1000, 2000, 3000, 4000),
      sec.axis = sec_axis(
         ~ 1239.842 / .,
         name = "Energy / eV",
         breaks = c(4, 2, 1, 0.5))) +
   scale_y_continuous(name = "Spectral irradiance / (W/m²/nm)") +
   labs(
      title = "Reference solar spectra by photoec::sunlight.ASTM()",
      # note that <code></code> (i.e., ``) is not supported yet by ggtext
      # and apparently \texttt{} is not supported by latex2exp::TeX()
      caption = latex2exp::TeX(r"(Data source: \textbf{photoec::sunlight.ASTM()})")) +
   theme(
      legend.position = c(0.98, 0.98),
      legend.justification = c(1, 1))
```

They look the same, and indeed, the values (here exemplified by AM1.5G) returned by
the dataset and the function are identical, as expected:

```{r diff-dataset-vs-function, echo=TRUE, results="markup"}
identical(
   datalong %>% filter(model == "AM1.5G") %>% filter(property == "spectral.irradiance") %>% pull(value),
   dflong %>% filter(model == "AM1.5G") %>% filter(property == "spectral.irradiance") %>% pull(value))
```

Whereas the dataset contains only spectral irradiance, the dataframe returned by
this package's `sunlight.ASTM()` function derives other properties, at the moment
absolute and relative cumulative irradiance (`irradiance` and `irradiance.fraction`).

```{r function-exploration, echo=FALSE}
p.irr <- ggplot(dflong %>% filter(property == "irradiance")) +
   geom_line(
      aes(
         x = wavelength,
         y = value,
         colour = model)) +
   geom_text(
      data = dflong %>%
         filter(property == "irradiance") %>%
         select(model, wavelength, value) %>%
         group_by(model) %>%
         # get the final irradiance value for each model
         # which is total irradiance since irradiance is the cumulative spectral irradiance
         # https://stackoverflow.com/a/53994503/1198249
         slice(tail(row_number(), 1)),
      hjust = 1.0, vjust = 1.4,
      aes(
         x = wavelength,
         y = value,
         colour = model,
         label = paste0(
            formatC(value, digits = 5, format = "fg"),
            " W/m²"))) +
   scale_x_continuous(
      name = "Wavelength / nm",
      breaks = c(250, 1000, 2000, 3000, 4000),
      sec.axis = sec_axis(
         ~ 1239.842 / .,
         name = "Energy / eV",
         breaks = c(4, 2, 1, 0.5))) +
   scale_y_continuous(name = "Irradiance / (W/m²)") +
   theme(legend.position = "none")
p.frac <- ggplot(dflong %>% filter(property == "irradiance.fraction")) +
   geom_line(aes(x = wavelength, y = value, colour = model)) +
   scale_x_continuous(
      name = "Wavelength / nm",
      breaks = c(250, 1000, 2000, 3000, 4000),
      sec.axis = sec_axis(
         ~ 1239.842 / .,
         name = "Energy / eV",
         breaks = c(4, 2, 1, 0.5))) +
   scale_y_continuous(name = "Irradiance fraction") +
   theme(
      legend.position = c(0.98, 0.02),
      legend.justification = c(1, 0))
# https://datavizpyr.com/join-multiple-plots-with-cowplot/
cowtitle <- ggdraw() +
   draw_label(
      "Cumulative irradiance in (a) absolute and (b) relative terms",
      x = 0, hjust = 0, size = 14) +
   # manually adjusted title left-side margin to align with left plot panel
   theme(plot.margin = margin(0, 0, 0, 45))
cowrow <- plot_grid(p.irr, p.frac, nrow = 1, labels = c("a", "b"))
cowplot::plot_grid(cowtitle, cowrow, ncol = 1, rel_heights = c(0.1, 1))
```



## Links

+ https://www.nrel.gov/grid/solar-resource/spectra-am1.5.html

